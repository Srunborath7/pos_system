<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Inventory Management</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet" />
    <link href="/css/style.css" rel="stylesheet" />
</head>
<body>
<div id="sidebar" aria-label="Sidebar navigation">
    <h4>POS System</h4>
    <hr />
    <ul class="nav flex-column">
        <li><a href="dashboard.html" class="nav-link text-white"><i class="bi bi-speedometer2"></i> Dashboard</a></li>
        <li><a href="pos.html" class="nav-link text-white"><i class="bi bi-receipt"></i> POS</a></li>
        <li><a href="customer.html" class="nav-link text-white"><i class="bi bi-people"></i> Customer</a></li>
        <li><a href="category.html" class="nav-link text-white"><i class="bi bi-tags"></i> Category</a></li>
        <li><a href="product.html" class="nav-link text-white"><i class="bi bi-box"></i> Product</a></li>
        <li><a href="inventory.html" class="nav-link text-white active"><i class="bi bi-archive"></i> Inventory</a></li>
        <li><a href="report.html" class="nav-link text-white"><i class="bi bi-bar-chart"></i> Report</a></li>
        <li><a href="register.html" class="nav-link text-white"><i class="bi bi-person-plus"></i> Register</a></li>
        <li><a href="settings.html" class="nav-link text-white"><i class="bi bi-gear"></i> Settings</a></li>
    </ul>
    <hr />
    <button class="btn btn-danger w-100" id="logoutBtn">Logout</button>
</div>
<div id="content">
    <h3>Dashboard | Inventory Management</h3>
    <form id="inventoryForm" class="mb-4" novalidate>
        <div >
            <div class="mb-3">
                <select class="form-select" id="productSelect" required></select>
            </div>
            <div class="mb-3">
                <select class="form-select" id="actionSelect" required>
                    <option value="">Action</option>
                    <option value="IN">IN</option>
                    <option value="OUT">OUT</option>
                </select>
            </div>
            <div class="mb-3">
                <input type="number" class="form-control" id="quantityInput" placeholder="Quantity" required />
            </div>
            <div class="mb-3">
                <input type="text" class="form-control" id="descriptionInput" placeholder="Description" />
            </div>
            <div class="mb-3">
                <button class="btn btn-success w-100" type="submit">Save</button>
            </div>
        </div>
    </form>

    <hr />

    <h3>Inventory Records</h3>
    <table class="table table-bordered table-striped">
        <thead class="table-dark">
        <tr>
            <th>ID</th>
            <th>Product</th>
            <th>Action</th>
            <th>Quantity</th>
            <th>Description</th>
            <th>Created At</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody id="inventoryTableBody">
        <tr><td colspan="6" class="text-center py-4">Loading inventory...</td></tr>
        </tbody>
    </table>
</div>
<script src="/js/sidebar.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
<script>
    const token = localStorage.getItem('token');
    const productSelect = document.getElementById('productSelect');
    const actionSelect = document.getElementById('actionSelect');
    const quantityInput = document.getElementById('quantityInput');
    const descriptionInput = document.getElementById('descriptionInput');
    const inventoryForm = document.getElementById('inventoryForm');
    const inventoryTableBody = document.getElementById('inventoryTableBody');

    let editingId = null;

    async function loadProducts() {
        const res = await fetch('/api/products', {
            headers: { 'Authorization': 'Bearer ' + token }
        });
        const products = await res.json();
        productSelect.innerHTML = '<option value="">Select Product</option>' +
            products.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
    }

    async function loadInventories() {
        const res = await fetch('/api/inventories', {
            headers: { 'Authorization': 'Bearer ' + token }
        });
        const inventories = await res.json();
        inventoryTableBody.innerHTML = inventories.map(inv => `
        <tr data-id="${inv.id}">
          <td>${inv.id}</td>
          <td>${inv.product?.name || ''}</td>
          <td>${inv.action}</td>
          <td>${inv.quantity}</td>
          <td>${inv.description || ''}</td>
          <td>${new Date(inv.createdAt).toLocaleString()}</td>
          <td>
            <button class="btn btn-sm btn-primary btn-edit">Edit</button>
            <button class="btn btn-sm btn-danger btn-delete">Delete</button>
          </td>
        </tr>
      `).join('');
    }

    inventoryForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const productId = productSelect.value;
        const action = actionSelect.value;
        const quantity = quantityInput.value;
        const description = descriptionInput.value;

        const payload = { productId, action, quantity, description };
        const method = editingId ? 'PUT' : 'POST';
        const url = '/api/inventories' + (editingId ? '/' + editingId : '');

        try {
            const res = await fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify(payload)
            });

            if (!res.ok) throw new Error(await res.text());
            Swal.fire('Success', editingId ? 'Inventory updated' : 'Inventory saved', 'success');
            inventoryForm.reset();
            editingId = null;
            await loadProducts();
            await loadInventories();
        } catch (err) {
            Swal.fire('Error', err.message, 'error');
        }
    });

    document.addEventListener('click', async (e) => {
        const row = e.target.closest('tr');
        const id = row?.getAttribute('data-id');

        // Edit
        if (e.target.classList.contains('btn-edit')) {
            const cells = row.querySelectorAll('td');
            const productName = cells[1].textContent;
            const action = cells[2].textContent;
            const quantity = cells[3].textContent;
            const description = cells[4].textContent;

            [...productSelect.options].forEach(opt => {
                if (opt.textContent === productName) opt.selected = true;
            });
            actionSelect.value = action;
            quantityInput.value = quantity;
            descriptionInput.value = description;
            editingId = id;
        }

        // Delete
        if (e.target.classList.contains('btn-delete')) {
            const confirm = await Swal.fire({
                title: 'Are you sure?',
                text: "This will permanently delete the record.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, delete it!'
            });

            if (confirm.isConfirmed) {
                try {
                    const res = await fetch('/api/inventories/' + id, {
                        method: 'DELETE',
                        headers: { 'Authorization': 'Bearer ' + token }
                    });
                    if (!res.ok) throw new Error(await res.text());
                    Swal.fire('Deleted!', 'Inventory has been deleted.', 'success');
                    await loadInventories();
                    await loadProducts();
                } catch (err) {
                    Swal.fire('Error', err.message, 'error');
                }
            }
        }
    });

    // Init
    loadProducts();
    loadInventories();
</script>
</body>
</html>
