<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Register Customer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap CSS & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

    <!-- SweetAlert2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet" />
    <link href="/css/style.css" rel="stylesheet" />
</head>
<body>

<!-- Sidebar -->
<div id="sidebar" aria-label="Sidebar navigation">
    <h4>POS System</h4>
    <hr />
    <ul class="nav flex-column">
        <li><a href="dashboard.html" class="nav-link text-white"><i class="bi bi-speedometer2"></i> Dashboard</a></li>
        <li><a href="pos.html" class="nav-link text-white"><i class="bi bi-receipt"></i> POS</a></li>
        <li><a href="customer.html" class="nav-link text-white active"><i class="bi bi-people"></i> Customer</a></li>
        <li><a href="category.html" class="nav-link text-white"><i class="bi bi-tags"></i> Category</a></li>
        <li><a href="product.html" class="nav-link text-white"><i class="bi bi-box"></i> Product</a></li>
        <li><a href="inventory.html" class="nav-link text-white"><i class="bi bi-archive"></i> Inventory</a></li>
        <li><a href="report.html" class="nav-link text-white"><i class="bi bi-bar-chart"></i> Report</a></li>
        <li><a href="register.html" class="nav-link text-white"><i class="bi bi-person-plus"></i> Register</a></li>
        <li><a href="settings.html" class="nav-link text-white"><i class="bi bi-gear"></i> Settings</a></li>
    </ul>
    <hr />
    <button class="btn btn-danger w-100" id="logoutBtn">Logout</button>
</div>

<!-- Main content -->
<div id="content" class="p-4">
    <h3>Dashboard | Customer</h3>
    <div class="card shadow p-4 mt-4 mx-auto" style="max-width: 800px; width: 100%;">
        <form id="customerForm" novalidate>
            <input type="hidden" id="customerId" value="" />
            <div class="mb-3">
                <label for="name" class="form-label fw-semibold">Name</label>
                <input type="text" id="name" class="form-control" placeholder="Full Name" required />
                <div class="invalid-feedback">Please enter the customer's name.</div>
            </div>

            <div class="mb-3">
                <label for="email" class="form-label fw-semibold">Email</label>
                <input type="email" id="email" class="form-control" placeholder="Email address" required />
                <div class="invalid-feedback">Please enter a valid email address.</div>
            </div>

            <div class="mb-3">
                <label for="phone" class="form-label fw-semibold">Phone</label>
                <input type="tel" id="phone" class="form-control" placeholder="Phone number" required />
                <div class="invalid-feedback">Please enter a phone number.</div>
            </div>

            <div class="mb-3">
                <label for="address" class="form-label fw-semibold">Address</label>
                <textarea id="address" class="form-control" rows="3" placeholder="Address" required></textarea>
                <div class="invalid-feedback">Please enter the address.</div>
            </div>

            <div class="mb-3">
                <label for="createdBy" class="form-label fw-semibold">Created By</label>
                <input type="text" id="createdBy" class="form-control" readonly />
            </div>

            <button type="submit" class="btn btn-primary w-100" id="submitBtn">Add Customer</button>
            <button type="button" class="btn btn-secondary w-100 mt-2 d-none" id="cancelEditBtn">Cancel Edit</button>
        </form>
    </div>

    <hr class="my-4" />

    <h3>Customer List</h3>
    <div class="table-responsive">
        <table class="table table-striped table-hover" id="customerTable">
            <thead class="table-dark">
            <tr>
                <th>Name</th><th>Email</th><th>Phone</th><th>Address</th><th>Created By</th><th>Actions</th>
            </tr>
            </thead>
            <tbody>
            <!-- Customer rows will be here -->
            </tbody>
        </table>
    </div>
</div>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>

<script>
    // Decode JWT payload helper
    function parseJwt(token) {
        try {
            const base64Payload = token.split('.')[1];
            const jsonPayload = atob(base64Payload);
            return JSON.parse(jsonPayload);
        } catch (e) {
            console.error('Invalid JWT token:', e);
            return null;
        }
    }

    let customers = [];
    const form = document.getElementById('customerForm');
    const submitBtn = document.getElementById('submitBtn');
    const cancelEditBtn = document.getElementById('cancelEditBtn');

    // Autofill createdBy field on load
    window.addEventListener('DOMContentLoaded', () => {
        const token = localStorage.getItem('token');
        if (token) {
            const payload = parseJwt(token);
            if (payload) {
                document.getElementById('createdBy').value = payload.sub || '';
            }
        }
        loadCustomers();
    });

    async function loadCustomers() {
        try {
            const res = await fetch('/api/customers', {
                headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
            });
            if (!res.ok) throw new Error('Failed to load customers');

            customers = await res.json();
            renderCustomerTable();
        } catch (error) {
            console.error(error);
            Swal.fire('Error', 'Failed to load customers.', 'error');
        }
    }

    function renderCustomerTable() {
        const tbody = document.querySelector('#customerTable tbody');
        tbody.innerHTML = '';
        if (customers.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">No customers found.</td></tr>`;
            return;
        }
        customers.forEach(customer => {
            tbody.innerHTML += `
                <tr>
                    <td>${customer.name}</td>
                    <td>${customer.email}</td>
                    <td>${customer.phone}</td>
                    <td>${customer.address}</td>
                    <td>${customer.createdBy?.username || ''}</td>
                    <td>
                        <button class="btn btn-sm btn-primary me-1" onclick="editCustomer(${customer.id})">
                            <i class="bi bi-pencil"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCustomer(${customer.id})">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </td>
                </tr>`;
        });
    }

    form.addEventListener('submit', async e => {
        e.preventDefault();
        if (!form.checkValidity()) {
            e.stopPropagation();
            form.classList.add('was-validated');
            return;
        }

        const customerId = document.getElementById('customerId').value;
        const data = {
            name: document.getElementById('name').value.trim(),
            email: document.getElementById('email').value.trim(),
            phone: document.getElementById('phone').value.trim(),
            address: document.getElementById('address').value.trim(),
            createdBy: document.getElementById('createdBy').value
        };

        try {
            let url = '/api/customers';
            let method = 'POST';

            if (customerId) {
                url += `/${customerId}`;
                method = 'PUT';
            }

            const res = await fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + localStorage.getItem('token'),
                },
                body: JSON.stringify(data)
            });

            const text = await res.text();

            if (!res.ok) {
                Swal.fire('Error', text || 'Operation failed', 'error');
                return;
            }

            Swal.fire('Success', `Customer ${customerId ? 'updated' : 'created'} successfully!`, 'success');
            form.reset();
            document.getElementById('customerId').value = '';
            submitBtn.textContent = 'Add Customer';
            cancelEditBtn.classList.add('d-none');

            // refill createdBy
            const token = localStorage.getItem('token');
            if (token) {
                const payload = parseJwt(token);
                if (payload) {
                    document.getElementById('createdBy').value = payload.sub || '';
                }
            }

            form.classList.remove('was-validated');
            await loadCustomers();
        } catch (error) {
            console.error(error);
            Swal.fire('Error', 'An error occurred. Please try again later.', 'error');
        }
    });

    cancelEditBtn.addEventListener('click', () => {
        form.reset();
        document.getElementById('customerId').value = '';
        submitBtn.textContent = 'Add Customer';
        cancelEditBtn.classList.add('d-none');
        form.classList.remove('was-validated');

        // refill createdBy
        const token = localStorage.getItem('token');
        if (token) {
            const payload = parseJwt(token);
            if (payload) {
                document.getElementById('createdBy').value = payload.sub || '';
            }
        }
    });

    async function editCustomer(id) {
        const customer = customers.find(c => c.id === id);
        if (!customer) return;

        document.getElementById('customerId').value = customer.id;
        document.getElementById('name').value = customer.name;
        document.getElementById('email').value = customer.email;
        document.getElementById('phone').value = customer.phone;
        document.getElementById('address').value = customer.address;
        document.getElementById('createdBy').value = customer.createdBy?.username || '';

        submitBtn.textContent = 'Update Customer';
        cancelEditBtn.classList.remove('d-none');
    }

    async function deleteCustomer(id) {
        const result = await Swal.fire({
            title: 'Confirm Deletion',
            text: 'Are you sure you want to delete this customer?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, delete it!',
        });

        if (!result.isConfirmed) return;

        try {
            const res = await fetch(`/api/customers/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
            });
            if (!res.ok) throw new Error('Failed to delete customer');

            Swal.fire('Deleted!', 'Customer has been deleted.', 'success');
            await loadCustomers();
        } catch (error) {
            console.error(error);
            Swal.fire('Error', 'Failed to delete customer.', 'error');
        }
    }
</script>

<script src="/js/sidebar.js"></script>
</body>
</html>
