<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>POS System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="/css/style.css" rel="stylesheet" />
  <style>
    body {
      background-color: #f8f9fa;
    }
    .product-card {
      cursor: pointer;
      transition: transform 0.2s ease;
      border: 1px solid transparent;
      border-radius: 5px;
      padding: 10px;
      margin-bottom: 15px;
      background-color: white;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .product-card:hover {
      transform: scale(1.02);
      border: 1px solid #198754;
    }
    .product-image {
      width: 60px;
      height: 60px;
      object-fit: contain;
      border: 1px solid #ddd;
      border-radius: 5px;
      background-color: #fff;
    }
    .cart-item input {
      width: 50px;
      text-align: center;
    }
  </style>
</head>
<body>
<div id="sidebar" aria-label="Sidebar navigation">
  <h4>POS System</h4>
  <hr />
  <ul class="nav flex-column">
    <li><a href="dashboard.html" class="nav-link text-white"><i class="bi bi-speedometer2"></i> Dashboard</a></li>
    <li><a href="pos.html" class="nav-link text-white active"><i class="bi bi-receipt"></i> POS</a></li>
    <li><a href="customer.html" class="nav-link "><i class="bi bi-people"></i> Customer</a></li>
    <li><a href="category.html" class="nav-link text-white"><i class="bi bi-tags"></i> Category</a></li>
    <li><a href="product.html" class="nav-link text-white"><i class="bi bi-box"></i> Product</a></li>
    <li><a href="inventory.html" class="nav-link text-white"><i class="bi bi-archive"></i> Inventory</a></li>
    <li><a href="report.html" class="nav-link text-white"><i class="bi bi-bar-chart"></i> Report</a></li>
    <li><a href="profile.html" class="nav-link text-white"><i class="bi bi-person"></i> Profile</a></li>
    <li><a href="register.html" class="nav-link text-white"><i class="bi bi-person-plus"></i> Register</a></li>
    <li><a href="settings.html" class="nav-link text-white"><i class="bi bi-gear"></i> Settings</a></li>
  </ul>
  <hr />
  <button class="btn btn-danger w-100" id="logoutBtn">Logout</button>
</div>
<div id="content" class="container-fluid mt-3">
  <h2>Point Of Sale</h2>
  <div class="row">
    <!-- Product List -->
    <div class="col-md-8">
      <h4 class="mb-3">üõçÔ∏è Products</h4>
      <div id="productList">
        <p>Loading products...</p>
      </div>
    </div>

    <!-- POS Cart -->
    <div class="col-md-4">
      <h4 class="mb-3">üßæ POS Cart</h4>
      <div class="card shadow-sm">
        <div class="card-body">
          <div id="cartItems" class="mb-3">
            <p class="text-muted">No items in cart</p>
          </div>
          <h5>Total: $<span id="totalPrice">0.00</span></h5>
          <button class="btn btn-success w-100 mt-3" onclick="checkout()">üíµ Process Payment</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // TODO: replace with actual JWT token from your login/auth system
  const token = localStorage.getItem('token') || 'YOUR_JWT_TOKEN_HERE';

  let products = [];
  const cart = [];

  async function loadProducts() {
    try {
      const res = await fetch('/api/products', {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      if (!res.ok) {
        const errText = await res.text();
        throw new Error(`Error ${res.status}: ${errText}`);
      }
      products = await res.json();
      window.products = products; // for addToCart to find products
      renderProducts();
    } catch (err) {
      console.error('Load products failed:', err);
      document.getElementById('productList').innerHTML = `<p class="text-danger">Failed to load products: ${err.message}</p>`;
    }
  }

  function renderProducts() {
    const container = document.getElementById('productList');
    if (!products.length) {
      container.innerHTML = '<p>No products available.</p>';
      return;
    }

    container.innerHTML = '';
    products.forEach(p => {
      const card = document.createElement('div');
      card.className = 'product-card';
      card.title = p.description || '';
      card.onclick = () => addToCart(p.id);

      const imgSrc = p.imageUrl ? `/uploads/product-images/${p.imageUrl}` : 'https://via.placeholder.com/60?text=No+Img';

      card.innerHTML = `
        <img src="${imgSrc}" alt="${p.name}" class="product-image" />
        <div>
          <strong>${p.name}</strong><br />
          Price: $${p.price.toFixed(2)}<br />
          Stock: ${p.stock}
        </div>
      `;

      container.appendChild(card);
    });
  }

  function addToCart(productId) {
    const product = products.find(p => p.id === productId);
    if (!product) return alert('Product not found');
    if (product.stock === 0) return alert('Product is out of stock!');

    const existing = cart.find(item => item.id === productId);
    if (existing) {
      if (existing.quantity < product.stock) {
        existing.quantity++;
      } else {
        alert('Stock limit reached!');
      }
    } else {
      cart.push({ ...product, quantity: 1 });
    }

    renderCart();
  }

  function renderCart() {
    const cartItems = document.getElementById('cartItems');
    const totalEl = document.getElementById('totalPrice');
    cartItems.innerHTML = '';
    let total = 0;

    if (cart.length === 0) {
      cartItems.innerHTML = '<p class="text-muted">No items in cart</p>';
      totalEl.textContent = '0.00';
      return;
    }

    cart.forEach((item, index) => {
      const itemTotal = item.price * item.quantity;
      total += itemTotal;
      const div = document.createElement('div');
      div.className = 'cart-item mb-2 d-flex justify-content-between align-items-center';
      div.innerHTML = `
        <div>
          <strong>${item.name}</strong><br />
          $${item.price.toFixed(2)} √ó
          <input type="number" value="${item.quantity}" min="1" max="${item.stock}" onchange="updateQty(${index}, this.value)" />
        </div>
        <div>
          $${itemTotal.toFixed(2)}
          <button class="btn btn-sm btn-danger ms-2" onclick="removeItem(${index})">√ó</button>
        </div>
      `;
      cartItems.appendChild(div);
    });

    totalEl.textContent = total.toFixed(2);
  }

  function updateQty(index, qty) {
    const quantity = parseInt(qty);
    const stock = cart[index].stock;
    if (quantity > 0 && quantity <= stock) {
      cart[index].quantity = quantity;
      renderCart();
    } else {
      alert(`Quantity must be between 1 and ${stock}`);
      renderCart();
    }
  }

  function removeItem(index) {
    cart.splice(index, 1);
    renderCart();
  }

  function checkout() {
    if (cart.length === 0) {
      alert('Cart is empty!');
      return;
    }

    const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
    const summary = cart.map(i => `${i.name} x${i.quantity} = $${(i.price * i.quantity).toFixed(2)}`).join('\n');

    alert(`‚úÖ Payment Successful!\n\nItems:\n${summary}\n\nTotal: $${total.toFixed(2)}\n\nüìå You can now connect this to a backend POST /orders endpoint.`);

    cart.length = 0;
    renderCart();
  }

  // Load products on page load
  loadProducts();
</script>
<script src="/js/sidebar.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
</body>
</html>
