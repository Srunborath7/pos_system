<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Category Management</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
    <!-- SweetAlert2 -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet" />
    <link href="/css/style.css" rel="stylesheet" />
    <style>
        body {
            padding: 1rem;
        }
        .table-container {
            max-width: 900px;
            margin: 2rem auto;
        }
    </style>
</head>
<body>
<div id="sidebar" aria-label="Sidebar navigation">
    <h4>POS System</h4>
    <hr />
    <ul class="nav flex-column">
        <li><a href="dashboard.html" class="nav-link text-white"><i class="bi bi-speedometer2"></i> Dashboard</a></li>
        <li><a href="pos.html" class="nav-link text-white"><i class="bi bi-receipt"></i> POS</a></li>
        <li><a href="customer.html" class="nav-link"><i class="bi bi-people"></i> Customer</a></li>
        <li><a href="category.html" class="nav-link active"><i class="bi bi-tags"></i> Category</a></li>
        <li><a href="product.html" class="nav-link text-white"><i class="bi bi-box"></i> Product</a></li>
        <li><a href="inventory.html" class="nav-link text-white"><i class="bi bi-archive"></i> Inventory</a></li>
        <li><a href="report.html" class="nav-link text-white"><i class="bi bi-bar-chart"></i> Report</a></li>
        <li><a href="profile.html" class="nav-link text-white"><i class="bi bi-person"></i> Profile</a></li>
        <li><a href="register.html" class="nav-link text-white"><i class="bi bi-person-plus"></i> Register</a></li>
        <li><a href="settings.html" class="nav-link text-white"><i class="bi bi-gear"></i> Settings</a></li>
    </ul>
    <hr />
    <button class="btn btn-danger w-100" id="logoutBtn">Logout</button>
</div>
<div id="content">
    <h2>Category Management</h2>
    <!-- Add Category Form -->
    <div class="card p-3 mt-4">
        <h4>Add Category</h4>
        <form id="categoryForm" novalidate>
            <div class="mb-3">
                <input type="text" id="name" class="form-control" placeholder="Category Name" required />
                <div class="invalid-feedback">Please enter category name.</div>
            </div>
            <div class="mb-3">
                <textarea id="description" class="form-control" placeholder="Description" rows="3"></textarea>
            </div>
            <button type="submit" class="btn btn-primary w-100">Add Category</button>
        </form>
    </div>

    <h2>Category Info</h2>
    <!-- Search -->
    <div class="mb-3">
        <input type="number" id="searchId" class="form-control" placeholder="Search by Category ID" />
    </div>

    <!-- Table -->
    <div class="table-responsive">
        <table class="table table-striped table-bordered align-middle">
            <thead class="table-dark">
            <tr>
                <th scope="col" style="min-width: 60px;">ID</th>
                <th scope="col" style="min-width: 150px;">Name</th>
                <th scope="col" style="min-width: 300px;">Description</th>
                <th scope="col" style="min-width: 150px;">Created By</th>
                <th scope="col" style="min-width: 150px;">Actions</th>
            </tr>
            </thead>
            <tbody id="categoryTableBody">
            <tr><td colspan="5" class="text-center py-4">Loading categories...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Update Modal -->
<div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="updateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <form class="modal-content" id="updateForm" novalidate>
            <div class="modal-header">
                <h5 class="modal-title" id="updateModalLabel">Update Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="updateId" />
                <div class="mb-3">
                    <label for="updateName" class="form-label">Category Name</label>
                    <input type="text" id="updateName" class="form-control" required />
                    <div class="invalid-feedback">Please enter category name.</div>
                </div>
                <div class="mb-3">
                    <label for="updateDescription" class="form-label">Description</label>
                    <textarea id="updateDescription" class="form-control" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Update Category</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- JS dependencies -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>

<script>
    // Parse JWT token payload
    function parseJwt(token) {
        try {
            const base64Payload = token.split('.')[1];
            const jsonPayload = atob(base64Payload);
            return JSON.parse(jsonPayload);
        } catch (e) {
            return null;
        }
    }

    // Fetch all categories
    async function fetchCategories() {
        const token = localStorage.getItem('token');
        if (!token) return [];

        const res = await fetch('/api/categories', {
            headers: { 'Authorization': 'Bearer ' + token }
        });
        if (!res.ok) throw new Error('Failed to fetch categories');

        return await res.json();
    }

    // Render categories in table with action buttons
    function renderCategories(categories) {
        const tbody = document.getElementById('categoryTableBody');
        if (!categories.length) {
            tbody.innerHTML = `<tr><td colspan="5" class="text-center">No categories found.</td></tr>`;
            return;
        }
        tbody.innerHTML = categories.map(cat => `
            <tr>
                <td>${cat.id}</td>
                <td>${cat.name}</td>
                <td>${cat.description || ''}</td>
                <td>${cat.createdBy ? cat.createdBy.username : 'N/A'}</td>
                <td>
                    <button class="btn btn-sm btn-warning me-2" onclick="openUpdateModal(${cat.id}, '${escapeHtml(cat.name)}', '${escapeHtml(cat.description || '')}')">
                        <i class="bi bi-pencil"></i> Edit
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteCategory(${cat.id})">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </td>
            </tr>
        `).join('');
    }

    // Escape HTML to prevent injection in JS
    function escapeHtml(text) {
        return text.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }

    // Load and optionally filter by ID
    async function loadCategories(filterId = null) {
        try {
            const allCategories = await fetchCategories();
            let filtered = allCategories;
            if (filterId !== null) {
                filtered = allCategories.filter(cat => cat.id === filterId);
            }
            renderCategories(filtered);
        } catch (error) {
            Swal.fire('Error', error.message, 'error');
        }
    }

    // Add new category
    async function addCategory(category) {
        const token = localStorage.getItem('token');
        const res = await fetch('/api/categories', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(category),
        });
        if (!res.ok) {
            const text = await res.text();
            throw new Error(text || 'Failed to add category');
        }
        return await res.json();
    }

    // Update category
    async function updateCategory(id, category) {
        const token = localStorage.getItem('token');
        const res = await fetch(`/api/categories/${id}`, {
            method: 'PUT',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(category),
        });
        if (!res.ok) {
            const text = await res.text();
            throw new Error(text || 'Failed to update category');
        }
        return await res.json();
    }

    // Delete category
    async function deleteCategory(id) {
        const result = await Swal.fire({
            title: 'Are you sure?',
            text: "This will permanently delete the category!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: 'Delete',
        });

        if (result.isConfirmed) {
            const token = localStorage.getItem('token');
            try {
                const res = await fetch(`/api/categories/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                    }
                });
                if (!res.ok) {
                    const text = await res.text();
                    throw new Error(text || 'Failed to delete category');
                }
                Swal.fire('Deleted!', 'Category has been deleted.', 'success');
                loadCategories();
            } catch (error) {
                Swal.fire('Error', error.message, 'error');
            }
        }
    }

    // Open update modal and pre-fill form
    function openUpdateModal(id, name, description) {
        const modal = new bootstrap.Modal(document.getElementById('updateModal'));
        document.getElementById('updateId').value = id;
        document.getElementById('updateName').value = name;
        document.getElementById('updateDescription').value = description;
        modal.show();
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
        loadCategories();

        document.getElementById('searchId').addEventListener('input', e => {
            const val = e.target.value.trim();
            const id = val ? parseInt(val, 10) : null;
            loadCategories(id);
        });

        // Add category form
        const form = document.getElementById('categoryForm');
        form.addEventListener('submit', async e => {
            e.preventDefault();
            form.classList.add('was-validated');
            if (!form.checkValidity()) return;

            const newCategory = {
                name: document.getElementById('name').value.trim(),
                description: document.getElementById('description').value.trim()
            };

            try {
                await addCategory(newCategory);
                Swal.fire('Success', 'Category added successfully!', 'success');
                form.reset();
                form.classList.remove('was-validated');
                loadCategories();
            } catch (error) {
                Swal.fire('Error', error.message, 'error');
            }
        });

        // Update category form in modal
        const updateForm = document.getElementById('updateForm');
        updateForm.addEventListener('submit', async e => {
            e.preventDefault();
            updateForm.classList.add('was-validated');
            if (!updateForm.checkValidity()) return;

            const id = document.getElementById('updateId').value;
            const updatedCategory = {
                name: document.getElementById('updateName').value.trim(),
                description: document.getElementById('updateDescription').value.trim()
            };

            try {
                await updateCategory(id, updatedCategory);
                Swal.fire('Success', 'Category updated successfully!', 'success');
                const modalEl = document.getElementById('updateModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();
                updateForm.classList.remove('was-validated');
                loadCategories();
            } catch (error) {
                Swal.fire('Error', error.message, 'error');
            }
        });
    });
</script>
<script src="/js/sidebar.js"></script>
</body>
</html>
